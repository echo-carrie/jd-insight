import e from"node:process";globalThis._importMeta_=globalThis._importMeta_||{url:"file:///_entry.js",env:e.env};import{d as t,r,a as o}from"../../../_/nitro.mjs";import{createRequire as s}from"module";import{OpenAI as a}from"openai";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:url";import"ipx";import"node:fs";import"node:path";import"node:crypto";const n=s(globalThis._importMeta_.url)("pdf-parse/lib/pdf-parse.js"),i=t(async e=>{var t,s;try{const i=await r(e);if(!i)throw new Error("无效的请求数据");let m="",p="",l=null,c="";for(const e of i)if("jdText"===e.name&&e.data)m=e.data.toString();else if("position"===e.name&&e.data)p=e.data.toString();else if("aiConfig"===e.name&&e.data)try{l=JSON.parse(e.data.toString())}catch(e){console.error("AI配置解析失败:",e)}else if("file"===e.name&&e.data)if(null==(t=e.filename)?void 0:t.endsWith(".pdf"))try{const t={max:0,pagerender:null};m=(await n(e.data,t)).text}catch(e){throw console.error("PDF解析错误:",e),new Error("PDF文件解析失败")}else if(null==(s=e.filename)?void 0:s.match(/\.(jpe?g|png|gif|webp)$/i))try{c=`data:${e.type};base64,${Buffer.from(e.data).toString("base64")}`}catch(e){throw console.error("图片处理错误:",e),new Error("图片处理失败")}if(!m&&!c)throw new Error("请提供JD文本、PDF文件或图片");if(!l){const e=o();if(!e.openaiApiKey)throw new Error("未配置API密钥，请前往设置页面配置");let t="";t=c?"请分析以下JD图片，提取三个关键维度的信息：\n\n1. 核心能力要求（3-5条）：提取岗位所需的关键能力和技能\n2. 岗位条件需求：总结学历、经验、必备技能等资格条件\n3. 核心产出物：提取岗位需要完成的主要文档、报告或成果\n\n"+(p?`岗位类型：${p}\n`:""):`\n作为一个专业的产品经理JD分析专家，请分析以下产品经理岗位JD，提取三个关键维度的信息：\n\n1. 核心能力要求（3-5条）：提取岗位所需的关键能力和技能\n2. 岗位条件需求：总结学历、经验、必备技能等资格条件\n3. 核心产出物：提取岗位需要完成的主要文档、报告或成果\n\n${p?`岗位类型：${p}\n`:""}\nJD内容：\n${m}\n`,t+="\n请以JSON格式返回分析结果，包含三个数组字段：coreAbilities、requirements、deliverables。每个数组包含对应维度的具体条目。",l={apiKey:e.openaiApiKey,baseURL:"https://api.openai.com/v1",model:"gpt-4-vision-preview",temperature:.3,maxTokens:2e3,topP:1,systemPrompt:"你是一个专业的产品经理JD分析专家，擅长提取JD中的关键信息并进行结构化输出。",userPrompt:t}}if(!l.apiKey)throw new Error("API密钥不能为空");const d=new a({apiKey:l.apiKey,baseURL:l.baseURL});let f,u;f=c?await d.chat.completions.create({model:"gpt-4-vision-preview",messages:[{role:"system",content:l.systemPrompt},{role:"user",content:[{type:"text",text:l.userPrompt},{type:"image_url",image_url:{url:c,detail:"high"}}]}],temperature:l.temperature,max_tokens:l.maxTokens,top_p:l.topP}):await d.chat.completions.create({model:l.model,messages:[{role:"system",content:l.systemPrompt},{role:"user",content:l.userPrompt}],temperature:l.temperature,max_tokens:l.maxTokens,top_p:l.topP,response_format:{type:"json_object"}});try{u=JSON.parse(f.choices[0].message.content||"{}")}catch(e){const t=f.choices[0].message.content||"";u={coreAbilities:extractListItems(t,"核心能力"),requirements:extractListItems(t,"岗位条件"),deliverables:extractListItems(t,"核心产出")}}const h=Math.random().toString(36).substring(2,15);return{success:!0,data:{coreAbilities:u.coreAbilities||[],requirements:u.requirements||[],deliverables:u.deliverables||[],requestId:h}}}catch(e){return console.error("分析错误:",e),{success:!1,message:e instanceof Error?e.message:"分析失败，请稍后重试"}}});function extractListItems(e,t){const r=new RegExp(`${t}[^:]*:([sS]*?)(?=\n\n|$)`,"i"),o=e.match(r);return o&&o[1]?o[1].split("\n").map(e=>e.trim()).filter(e=>e.startsWith("-")||e.startsWith("•")||/^\d+\./.test(e)).map(e=>e.replace(/^[-•\d\.\s]+/,"").trim()).filter(Boolean):[]}export{i as default};
//# sourceMappingURL=analyze.post.mjs.map
