import{d as e,r as t}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:url";import"ipx";import"node:fs";import"node:path";import"node:crypto";const r=e(async e=>{var r,o;try{const n=await t(e);if(!n)throw new Error("无效的请求数据");let s="",i="",a=null,c="";for(const e of n)if("jdText"===e.name&&e.data)s=e.data.toString();else if("position"===e.name&&e.data)i=e.data.toString();else if("aiConfig"===e.name&&e.data)try{a=JSON.parse(e.data.toString())}catch(e){console.error("AI配置解析失败:",e)}else if("file"===e.name&&e.data){if(null==(r=e.filename)?void 0:r.endsWith(".pdf"))throw new Error("在当前环境中不支持PDF解析，请直接复制JD文本或上传图片");if(null==(o=e.filename)?void 0:o.match(/\.(jpe?g|png|gif|webp)$/i))try{c=`data:${e.type};base64,${Buffer.from(e.data).toString("base64")}`}catch(e){throw console.error("图片处理错误:",e),new Error("图片处理失败")}}if(!s&&!c)throw new Error("请提供JD文本、PDF文件或图片");if(!a||!a.apiKey)throw new Error("请先配置AI模型API密钥，可以在设置页面进行配置");const m=Math.random().toString(36).substring(2,15),l=await async function(e,t,r){var o;try{const n=`${r.baseURL}/chat/completions`,s={model:r.model,messages:[{role:"system",content:r.systemPrompt||"你是一个专业的产品经理JD分析专家，擅长提取JD中的关键信息并进行结构化输出。"},{role:"user",content:r.userPrompt||`\n作为一个专业的产品经理JD分析专家，请分析以下产品经理岗位JD，提取三个关键维度的信息：\n\n1. 核心能力要求（3-5条）：提取岗位所需的关键能力和技能\n2. 岗位条件需求：总结学历、经验、必备技能等资格条件\n3. 核心产出物：提取岗位需要完成的主要文档、报告或成果\n\n${t?`岗位类型：${t}\n`:""}\nJD内容：\n${e}\n\n请以JSON格式返回分析结果，包含三个数组字段：coreAbilities、requirements、deliverables。每个数组包含对应维度的具体条目。\n`}],temperature:r.temperature||.3,max_tokens:r.maxTokens||2e3,top_p:r.topP||1,response_format:{type:"json_object"}},i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},body:JSON.stringify(s)});if(!i.ok){const e=await i.json();throw new Error(`API请求失败: ${(null==(o=e.error)?void 0:o.message)||i.statusText}`)}const a=await i.json();let c;try{const e=a.choices[0].message.content||"{}";c=JSON.parse(e)}catch(e){const t=a.choices[0].message.content||"";c={coreAbilities:extractListItems(t,"核心能力"),requirements:extractListItems(t,"岗位条件"),deliverables:extractListItems(t,"核心产出")}}return{coreAbilities:c.coreAbilities||[],requirements:c.requirements||[],deliverables:c.deliverables||[]}}catch(e){return console.error("API调用错误:",e),{coreAbilities:["需要配置有效的API密钥才能进行分析"],requirements:["请在设置中配置有效的API密钥"],deliverables:["API调用失败，无法提供分析结果"]}}}(s||c,i,a);return{success:!0,data:{...l,requestId:m}}}catch(e){return console.error("分析错误:",e),{success:!1,message:e instanceof Error?e.message:"分析失败，请稍后重试"}}});function extractListItems(e,t){const r=new RegExp(`${t}[^:]*:([sS]*?)(?=\n\n|$)`,"i"),o=e.match(r);return o&&o[1]?o[1].split("\n").map(e=>e.trim()).filter(e=>e.startsWith("-")||e.startsWith("•")||/^\d+\./.test(e)).map(e=>e.replace(/^[-•\d\.\s]+/,"").trim()).filter(Boolean):[]}export{r as default};
//# sourceMappingURL=analyze.post.mjs.map
